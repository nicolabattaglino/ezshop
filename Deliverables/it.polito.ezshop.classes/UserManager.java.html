<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ezshop$SaleTransactionObjTest.exec</a> &gt; <a href="index.source.html" class="el_package">it.polito.ezshop.classes</a> &gt; <span class="el_source">UserManager.java</span></div><h1>UserManager.java</h1><pre class="source lang-java linenums">package it.polito.ezshop.classes;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.fasterxml.jackson.databind.ser.std.MapSerializer;
import it.polito.ezshop.data.EZShop;
import it.polito.ezshop.data.User;
import it.polito.ezshop.exceptions.*;
import java.io.File;
import java.io.IOException;
import java.util.LinkedList;
import java.util.List;

public class UserManager {
    
    public static final String USERS_PATH = &quot;data/users.json&quot;;
    public static final String USERS_ID_PATH = &quot;data/userIdGen.json&quot;;
    
    @JsonSerialize(keyUsing = MapSerializer.class)
    @JsonDeserialize
    private LinkedList&lt;UserObj&gt; userList;
<span class="nc" id="L23">    private Integer userIdGen = 0;</span>
    private User loggedUser;
    private EZShop shop;

<span class="nc" id="L27">    public UserManager(EZShop shop) {</span>
<span class="nc" id="L28">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L29">        TypeReference&lt;LinkedList&lt;UserObj&gt;&gt; typeRef = new TypeReference&lt;LinkedList&lt;UserObj&gt;&gt;() {</span>
        };
<span class="nc" id="L31">        File users = new File(USERS_PATH);</span>
        try {
<span class="nc" id="L33">            users.createNewFile();</span>
<span class="nc" id="L34">            userList = mapper.readValue(users, typeRef);</span>
<span class="nc" id="L35">        } catch (IOException e) {</span>
<span class="nc" id="L36">            users.delete();</span>
            try {
<span class="nc" id="L38">                users.createNewFile();</span>
<span class="nc" id="L39">            } catch (IOException ioException) {</span>
<span class="nc" id="L40">                ioException.printStackTrace();</span>
            } finally {
<span class="nc" id="L42">                userList = new LinkedList&lt;&gt;();</span>
            }
<span class="nc" id="L44">        }</span>
<span class="nc" id="L45">        TypeReference&lt;Integer&gt; typeRef2 = new TypeReference&lt;Integer&gt;() {</span>
        };
<span class="nc" id="L47">        File usersId = new File(USERS_ID_PATH);</span>
        try {
<span class="nc" id="L49">            usersId.createNewFile();</span>
<span class="nc" id="L50">            userIdGen = mapper.readValue(usersId, typeRef2);</span>
<span class="nc" id="L51">        } catch (IOException e) {</span>
<span class="nc" id="L52">            usersId.delete();</span>
            try {
<span class="nc" id="L54">                usersId.createNewFile();</span>
<span class="nc" id="L55">            } catch (IOException ioException) {</span>
<span class="nc" id="L56">                ioException.printStackTrace();</span>
            } finally {
<span class="nc" id="L58">                userIdGen = 0;</span>
            }
<span class="nc" id="L60">        }</span>
        
<span class="nc" id="L62">    }</span>
    
    
    public User getUserLogged() {
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (loggedUser == null) return null;</span>
<span class="nc" id="L67">        return new UserObj(loggedUser.getId(), loggedUser.getUsername(), loggedUser.getPassword(), UserRole.valueOf(loggedUser.getRole()));</span>
    }
    
    public Integer createUser(String username, String password, String role) throws InvalidUsernameException, InvalidPasswordException, InvalidRoleException {
<span class="nc bnc" id="L71" title="All 4 branches missed.">        if (username == null || username.equals(&quot;&quot;))</span>
<span class="nc" id="L72">            throw new InvalidUsernameException();</span>
        
<span class="nc bnc" id="L74" title="All 4 branches missed.">        if (password == null || password.equals(&quot;&quot;))</span>
<span class="nc" id="L75">            throw new InvalidPasswordException();</span>
        
<span class="nc bnc" id="L77" title="All 4 branches missed.">        if (role == null || role.equals(&quot;&quot;) ||</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                (!role.equalsIgnoreCase(&quot;ADMINISTRATOR&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                        !role.equalsIgnoreCase(&quot;CASHIER&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">                        !role.equalsIgnoreCase(&quot;SHOPMANAGER&quot;)))</span>
<span class="nc" id="L81">            throw new InvalidRoleException();</span>
        
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (User user : userList) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (user.getUsername().equals(username))</span>
<span class="nc" id="L85">                return -1;</span>
<span class="nc" id="L86">        }</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (userList.size() == 0) {</span>
<span class="nc" id="L88">            userIdGen = 0;</span>
        } else {
<span class="nc" id="L90">            userIdGen = userIdGen + 1;</span>
        }
<span class="nc" id="L92">        UserObj u = new UserObj(userIdGen, username, password, UserRole.valueOf(role.toUpperCase()));</span>
        
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!userList.add(u))</span>
<span class="nc" id="L95">            return -1;</span>
        try {
<span class="nc" id="L97">            persistUsers();</span>
<span class="nc" id="L98">            persistUsersId();</span>
<span class="nc" id="L99">        } catch (IOException e) {</span>
<span class="nc" id="L100">            userList.removeLast();</span>
<span class="nc" id="L101">            userIdGen = userList.getLast().getId();</span>
<span class="nc" id="L102">            e.printStackTrace();</span>
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">        return userIdGen;</span>
        
    }
    
    public boolean deleteUser(Integer id) throws InvalidUserIdException, UnauthorizedException {
<span class="nc" id="L109">        int i = 0;</span>
<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (id == null || id &lt; 0)</span>
<span class="nc" id="L111">            throw new InvalidUserIdException();</span>
        UserObj u;
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (i = 0; i &lt; userList.size(); i++) {</span>
<span class="nc" id="L114">            u = userList.get(i);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (u.getId().equals(id)) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                if (u != userList.remove(i)) {</span>
<span class="nc" id="L117">                    return false;</span>
                } else {
                    try {
<span class="nc" id="L120">                        persistUsers();</span>
<span class="nc" id="L121">                    } catch (IOException e) {</span>
<span class="nc" id="L122">                        userList.add(u);</span>
<span class="nc" id="L123">                        e.printStackTrace();</span>
<span class="nc" id="L124">                    }</span>
<span class="nc" id="L125">                    return true;</span>
                }
            }
        }
<span class="nc" id="L129">        return false;</span>
    }
    
    public List&lt;User&gt; getAllUsers() throws UnauthorizedException {
<span class="nc" id="L133">        return new LinkedList&lt;User&gt;(userList);</span>
    }
    
    public User getUser(Integer id) throws InvalidUserIdException, UnauthorizedException {
<span class="nc" id="L137">        int i = 0;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (id &lt; 0)</span>
<span class="nc" id="L139">            throw new InvalidUserIdException();</span>
        
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (User u : userList) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (u.getId().equals(id)) {</span>
<span class="nc" id="L143">                return new UserObj(u.getId(), u.getUsername(), u.getPassword(), UserRole.valueOf(u.getRole()));</span>
<span class="nc" id="L144">            } else u = null;</span>
<span class="nc" id="L145">        }</span>
<span class="nc" id="L146">        return null;</span>
    }
    
    public boolean updateUserRights(Integer id, String role) throws InvalidUserIdException, InvalidRoleException, UnauthorizedException {
<span class="nc" id="L150">        int i = 0;</span>
        
<span class="nc bnc" id="L152" title="All 4 branches missed.">        if (id == null || id &lt; 0)</span>
<span class="nc" id="L153">            throw new InvalidUserIdException();</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">        if (role == null || role.equals(&quot;&quot;) ||</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                (!role.toUpperCase().equals(UserRole.ADMINISTRATOR.toString()) &amp;&amp;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                        !role.toUpperCase().equals(UserRole.CASHIER.toString()) &amp;&amp;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                        !role.toUpperCase().equals(UserRole.SHOPMANAGER.toString())))</span>
<span class="nc" id="L158">            throw new InvalidRoleException();</span>
<span class="nc" id="L159">        String ur = userList.get(id).getRole();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (i = 0; i &lt; userList.size(); i++) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (userList.get(i).getId().equals(id)) {</span>
<span class="nc" id="L162">                User u = userList.get(i);</span>
<span class="nc" id="L163">                u.setRole(role.toUpperCase());</span>
                try {
<span class="nc" id="L165">                    persistUsers();</span>
<span class="nc" id="L166">                } catch (IOException e) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                    for (i = 0; i &lt; userList.size(); i++) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                        if (userList.get(i).getId().equals(id)) {</span>
<span class="nc" id="L169">                            u = userList.get(i);</span>
<span class="nc" id="L170">                            u.setRole(ur.toUpperCase());</span>
                        }
                    }
<span class="nc" id="L173">                    e.printStackTrace();</span>
<span class="nc" id="L174">                }</span>
<span class="nc" id="L175">                return true;</span>
            }
        }
<span class="nc" id="L178">        return false;</span>
    }
    
    public User login(String username, String password) throws InvalidUsernameException, InvalidPasswordException {
<span class="nc" id="L182">        int i = 0;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        for (User u : userList) {</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">            if (u.getUsername().equals(username) &amp;&amp; u.getPassword().equals(password)) {</span>
<span class="nc" id="L185">                loggedUser = u;</span>
<span class="nc" id="L186">                return loggedUser;</span>
            }
<span class="nc" id="L188">        }</span>
<span class="nc" id="L189">        return null;</span>
    }
    
    public boolean logout() {
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (loggedUser == null)</span>
<span class="nc" id="L194">            return false;</span>
<span class="nc" id="L195">        loggedUser = null;</span>
<span class="nc" id="L196">        return true;</span>
    }
    
    public void clear() {
<span class="nc" id="L200">        userList.clear();</span>
<span class="nc" id="L201">        File users = new File(USERS_PATH);</span>
<span class="nc" id="L202">        users.delete();</span>
        
<span class="nc" id="L204">    }</span>
    
    private void persistUsers() throws IOException {
<span class="nc" id="L207">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L208">        mapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L209">                .writeValue(new File(USERS_PATH), userList);</span>
        
<span class="nc" id="L211">    }</span>
    
    private void persistUsersId() throws IOException {
<span class="nc" id="L214">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L215">        mapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L216">                .writeValue(new File(USERS_ID_PATH), userIdGen);</span>
<span class="nc" id="L217">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>