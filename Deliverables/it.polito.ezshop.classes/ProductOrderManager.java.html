<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductOrderManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ezshop$SaleTransactionObjTest.exec</a> &gt; <a href="index.source.html" class="el_package">it.polito.ezshop.classes</a> &gt; <span class="el_source">ProductOrderManager.java</span></div><h1>ProductOrderManager.java</h1><pre class="source lang-java linenums">package it.polito.ezshop.classes;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.fasterxml.jackson.databind.ser.std.MapSerializer;
import it.polito.ezshop.data.EZShop;
import it.polito.ezshop.data.Order;
import it.polito.ezshop.data.ProductType;
import it.polito.ezshop.exceptions.*;

import java.io.File;
import java.io.IOException;
import java.util.*;
import java.util.stream.Collectors;

public class ProductOrderManager {
    
    public static final String PRODUCTS_PATH = &quot;data/products.json&quot;;
    public static final String PRODUCT_GEN_PATH = &quot;data/product_gen.json&quot;;
    public static final String ORDER_GEN_PATH = &quot;data/order_gen.json&quot;;
    private final EZShop shop;
    @JsonSerialize(keyUsing = MapSerializer.class)
    @JsonDeserialize
    private Map&lt;String, ProductTypeObj&gt; productMap;
    
    private int productIdGen;
    private int orderIdGen;
    
<span class="nc" id="L31">    public ProductOrderManager(EZShop shop) {</span>
<span class="nc" id="L32">        this.shop = shop;</span>
<span class="nc" id="L33">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L34">        TypeReference&lt;HashMap&lt;String, ProductTypeObj&gt;&gt; typeRef = new TypeReference&lt;HashMap&lt;String, ProductTypeObj&gt;&gt;() {</span>
        };
<span class="nc" id="L36">        File products = new File(PRODUCTS_PATH);</span>
        try {
<span class="nc" id="L38">            products.createNewFile();</span>
<span class="nc" id="L39">            productMap = mapper.readValue(products, typeRef);</span>
<span class="nc" id="L40">        } catch (IOException e) {</span>
<span class="nc" id="L41">            products.delete();</span>
            try {
<span class="nc" id="L43">                products.createNewFile();</span>
<span class="nc" id="L44">            } catch (IOException ioException) {</span>
<span class="nc" id="L45">                ioException.printStackTrace();</span>
            } finally {
<span class="nc" id="L47">                productMap = new HashMap&lt;&gt;();</span>
            }
<span class="nc" id="L49">        }</span>
<span class="nc" id="L50">        File productGen = new File(PRODUCT_GEN_PATH);</span>
        try {
<span class="nc" id="L52">            productGen.createNewFile();</span>
<span class="nc" id="L53">            productIdGen = mapper.readValue(productGen, Integer.class);</span>
<span class="nc" id="L54">        } catch (IOException e) {</span>
<span class="nc" id="L55">            productGen.delete();</span>
            try {
<span class="nc" id="L57">                productGen.createNewFile();</span>
<span class="nc" id="L58">                mapper.writerWithDefaultPrettyPrinter().writeValue(productGen, 1);</span>
<span class="nc" id="L59">            } catch (IOException ioException) {</span>
<span class="nc" id="L60">                ioException.printStackTrace();</span>
            } finally {
<span class="nc" id="L62">                productIdGen = 1;</span>
            }
<span class="nc" id="L64">        }</span>
<span class="nc" id="L65">        File orderGen = new File(ORDER_GEN_PATH);</span>
        try {
<span class="nc" id="L67">            orderGen.createNewFile();</span>
<span class="nc" id="L68">            orderIdGen = mapper.readValue(productGen, Integer.class);</span>
<span class="nc" id="L69">        } catch (IOException e) {</span>
<span class="nc" id="L70">            orderGen.delete();</span>
            try {
<span class="nc" id="L72">                orderGen.createNewFile();</span>
<span class="nc" id="L73">                mapper.writerWithDefaultPrettyPrinter().writeValue(orderGen, 1);</span>
<span class="nc" id="L74">            } catch (IOException ioException) {</span>
<span class="nc" id="L75">                ioException.printStackTrace();</span>
            } finally {
<span class="nc" id="L77">                orderIdGen = 1;</span>
            }
<span class="nc" id="L79">        }</span>
<span class="nc" id="L80">    }</span>
    
    public boolean checkBarcode(String barCode) {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (barCode == null) return false;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!barCode.matches(&quot;[0-9]{12,14}&quot;)) return false;</span>
<span class="nc" id="L85">        final int length = barCode.length();</span>
<span class="nc" id="L86">        int checkValue = barCode.charAt(length - 1) - '0';</span>
<span class="nc" id="L87">        int res = 0;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        for (int i = 0; i &lt; length - 1; i++) {</span>
<span class="nc" id="L89">            int factor = 1;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (i % 2 == 0) factor = 3;</span>
<span class="nc" id="L91">            res += factor * (barCode.charAt(length - i - 2) - '0');</span>
        }
        
<span class="nc" id="L94">        res = 10 - (res % 10);</span>
        
<span class="nc bnc" id="L96" title="All 2 branches missed.">        return res == checkValue;</span>
    }
    
    public Integer createProductType(String description, String productCode, double pricePerUnit, String note) throws InvalidProductCodeException, InvalidProductDescriptionException, InvalidPricePerUnitException {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (!checkBarcode(productCode)) {</span>
<span class="nc" id="L101">            throw new InvalidProductCodeException();</span>
        }
<span class="nc bnc" id="L103" title="All 4 branches missed.">        if (description == null || description.trim().length() == 0)</span>
<span class="nc" id="L104">            throw new InvalidProductDescriptionException();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (pricePerUnit &lt;= 0)</span>
<span class="nc" id="L106">            throw new InvalidPricePerUnitException();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (productMap.containsKey(productCode))</span>
<span class="nc" id="L108">            return -1;</span>
<span class="nc" id="L109">        productIdGen++;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        productMap.put(productCode, new ProductTypeObj(0, productIdGen, description, productCode, (note == null) ? &quot;&quot; : note, pricePerUnit, 0));</span>
        try {
<span class="nc" id="L112">            persistProducts();</span>
<span class="nc" id="L113">            persistGen();</span>
<span class="nc" id="L114">        } catch (IOException e) {</span>
<span class="nc" id="L115">            productMap.remove(productCode);</span>
<span class="nc" id="L116">            productIdGen--;</span>
<span class="nc" id="L117">            return -1;</span>
<span class="nc" id="L118">        }</span>
<span class="nc" id="L119">        return productIdGen;</span>
    }
    
    public boolean updateProduct(Integer id, String newDescription, String newCode, double newPrice, String newNote) throws InvalidProductIdException, InvalidProductDescriptionException, InvalidProductCodeException, InvalidPricePerUnitException {
<span class="nc bnc" id="L123" title="All 4 branches missed.">        if (id == null || id &lt;= 0) throw new InvalidProductIdException();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (newPrice &lt;= 0) {</span>
<span class="nc" id="L125">            throw new InvalidPricePerUnitException();</span>
        }
<span class="nc bnc" id="L127" title="All 4 branches missed.">        if (newDescription == null || newDescription.trim().length() == 0)</span>
<span class="nc" id="L128">            throw new InvalidProductDescriptionException();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (!checkBarcode(newCode))</span>
<span class="nc" id="L130">            throw new InvalidProductCodeException();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (productMap.containsKey(newCode)) return false;</span>
        
<span class="nc" id="L133">        ProductTypeObj candidate = null;</span>
        
<span class="nc bnc" id="L135" title="All 2 branches missed.">        for (ProductTypeObj productType : productMap.values()) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (productType.getId().equals(id)) candidate = productType;</span>
<span class="nc" id="L137">        }</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        if (candidate == null) return false;</span>
<span class="nc" id="L139">        ProductTypeObj old = new ProductTypeObj(candidate);</span>
        //TODO vedi se la remove rimuove anche la chiave
<span class="nc" id="L141">        productMap.remove(candidate.getBarCode());</span>
<span class="nc" id="L142">        candidate.setProductDescription(newDescription);</span>
<span class="nc" id="L143">        candidate.setBarCode(newCode);</span>
<span class="nc" id="L144">        candidate.setPricePerUnit(newPrice);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        candidate.setNote(newNote == null ? &quot;&quot; : newNote);</span>
<span class="nc" id="L146">        productMap.put(newCode, candidate);</span>
        try {
<span class="nc" id="L148">            persistProducts();</span>
<span class="nc" id="L149">        } catch (IOException e) {</span>
<span class="nc" id="L150">            productMap.remove(candidate.getBarCode());</span>
<span class="nc" id="L151">            productMap.put(old.getBarCode(), old);</span>
<span class="nc" id="L152">            return false;</span>
<span class="nc" id="L153">        }</span>
        
<span class="nc" id="L155">        return true;</span>
    }
    
    public boolean deleteProductType(Integer id) throws InvalidProductIdException {
<span class="nc bnc" id="L159" title="All 4 branches missed.">        if (id == null || id &lt;= 0) throw new InvalidProductIdException();</span>
<span class="nc" id="L160">        ProductTypeObj candidate = null;</span>
        
<span class="nc bnc" id="L162" title="All 2 branches missed.">        for (ProductTypeObj productType : productMap.values()) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            if (productType.getId().equals(id)) candidate = productType;</span>
<span class="nc" id="L164">        }</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (candidate == null) return false;</span>
<span class="nc" id="L166">        productMap.remove(candidate.getBarCode());</span>
        try {
<span class="nc" id="L168">            persistProducts();</span>
<span class="nc" id="L169">        } catch (IOException e) {</span>
<span class="nc" id="L170">            productMap.put(candidate.getBarCode(), candidate);</span>
<span class="nc" id="L171">            return false;</span>
<span class="nc" id="L172">        }</span>
<span class="nc" id="L173">        return true;</span>
    }
    
    public List&lt;ProductType&gt; getAllProductTypes() {
<span class="nc" id="L177">        ArrayList&lt;ProductType&gt; ret = new ArrayList&lt;&gt;(productMap.values().size());</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (ProductTypeObj value : productMap.values()) {</span>
<span class="nc" id="L179">            ret.add(new ProductTypeObj(value));</span>
<span class="nc" id="L180">        }</span>
<span class="nc" id="L181">        return ret;</span>
    }
    
    public ProductType getProductTypeByBarCode(String barCode) throws InvalidProductCodeException {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (!checkBarcode(barCode)) throw new InvalidProductCodeException();</span>
<span class="nc" id="L186">        return new ProductTypeObj(productMap.get(barCode));</span>
    }
    
    public List&lt;ProductType&gt; getProductTypesByDescription(String description) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">        final String desc = description == null ? &quot;&quot; : description;</span>
<span class="nc" id="L191">        return productMap.values().stream()</span>
<span class="nc" id="L192">                .filter(productType -&gt; productType.getProductDescription().equals(desc))</span>
<span class="nc" id="L193">                .map(ProductTypeObj::new)</span>
<span class="nc" id="L194">                .collect(Collectors.toList());</span>
    }
    
    public boolean updateQuantity(Integer productId, int toBeAdded) throws InvalidProductIdException {
<span class="nc bnc" id="L198" title="All 4 branches missed.">        if (productId == null || productId &lt;= 0) throw new InvalidProductIdException();</span>
        ProductType target;
<span class="nc bnc" id="L200" title="All 2 branches missed.">        for (ProductType p : productMap.values()) {</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">            if (p.getId().equals(productId) &amp;&amp; p.getLocation() != null) {</span>
<span class="nc" id="L202">                final int oldQuantity = p.getQuantity();</span>
<span class="nc" id="L203">                int quantity = oldQuantity + toBeAdded;</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (quantity &gt;= 0) {</span>
<span class="nc" id="L205">                    p.setQuantity(quantity);</span>
                    try {
<span class="nc" id="L207">                        persistProducts();</span>
<span class="nc" id="L208">                    } catch (IOException e) {</span>
<span class="nc" id="L209">                        p.setQuantity(oldQuantity);</span>
<span class="nc" id="L210">                        return false;</span>
<span class="nc" id="L211">                    }</span>
<span class="nc" id="L212">                    return true;</span>
<span class="nc" id="L213">                } else return false;</span>
            }
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">        return false;</span>
    }
    
    public boolean updatePosition(Integer productId, String newPos) throws InvalidProductIdException, InvalidLocationException {
<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (productId == null || productId &lt;= 0) throw new InvalidProductIdException();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        newPos = (newPos == null) ? &quot;&quot; : newPos;</span>
<span class="nc" id="L222">        ProductType target = null;</span>
<span class="nc" id="L223">        String oldLoc = &quot;&quot;;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        for (ProductType p : productMap.values()) {</span>
<span class="nc" id="L225">            oldLoc = p.getLocation();</span>
<span class="nc bnc" id="L226" title="All 4 branches missed.">            if (oldLoc.equals(newPos) &amp;&amp; !newPos.equals(&quot;&quot;)) return false;</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (p.getId().equals(productId))</span>
<span class="nc" id="L228">                target = p;</span>
<span class="nc" id="L229">        }</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (target == null) return false;</span>
<span class="nc" id="L231">        target.setLocation(newPos);</span>
        try {
<span class="nc" id="L233">            persistProducts();</span>
<span class="nc" id="L234">        } catch (IOException e) {</span>
<span class="nc" id="L235">            target.setLocation(oldLoc);</span>
<span class="nc" id="L236">            return false;</span>
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">        return true;</span>
    }
    
    public Integer issueOrder(String productCode, int quantity, double pricePerUnit) throws InvalidProductCodeException, InvalidQuantityException, InvalidPricePerUnitException {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (quantity &lt;= 0) throw new InvalidQuantityException();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (pricePerUnit &lt;= 0) throw new InvalidPricePerUnitException();</span>
<span class="nc" id="L244">        ProductType p = getProductTypeByBarCode(productCode);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (p == null) return -1;</span>
<span class="nc" id="L246">        OrderObj order = new OrderObj(orderIdGen++, p, pricePerUnit, quantity);</span>
        try {
<span class="nc" id="L248">            persistGen();</span>
<span class="nc" id="L249">        } catch (IOException e) {</span>
<span class="nc" id="L250">            orderIdGen--;</span>
<span class="nc" id="L251">            return -1;</span>
<span class="nc" id="L252">        }</span>
<span class="nc" id="L253">        shop.addOrder(order);</span>
<span class="nc" id="L254">        return order.getOrderId();</span>
    }
    
    public Integer payOrderFor(String productCode, int quantity, double pricePerUnit)
            throws InvalidProductCodeException, InvalidQuantityException, InvalidPricePerUnitException {
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (!checkBarcode(productCode)) throw new InvalidProductCodeException();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (quantity &lt;= 0) throw new InvalidQuantityException();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (pricePerUnit &lt;= 0) throw new InvalidPricePerUnitException();</span>
<span class="nc" id="L262">        ProductType target = getProductTypeByBarCode(productCode);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        if (target == null) return -1;</span>
<span class="nc" id="L264">        OrderObj o = new OrderObj(orderIdGen++, target, pricePerUnit, quantity);</span>
        try {
<span class="nc" id="L266">            persistGen();</span>
<span class="nc" id="L267">        } catch (IOException e) {</span>
<span class="nc" id="L268">            orderIdGen--;</span>
<span class="nc" id="L269">            return -1;</span>
<span class="nc" id="L270">        }</span>
<span class="nc" id="L271">        o.setStatus(&quot;payed&quot;);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!shop.addOrder(o)) return -1;</span>
<span class="nc" id="L273">        return o.getOrderId();</span>
    }
    
    public boolean payOrder(Integer orderId) throws InvalidOrderIdException, UnauthorizedException {
<span class="nc bnc" id="L277" title="All 4 branches missed.">        if (orderId == null || orderId &lt;= 0) throw new InvalidOrderIdException();</span>
<span class="nc" id="L278">        Optional&lt;Order&gt; target = shop.getAllOrders().stream()</span>
<span class="nc" id="L279">                .filter(order -&gt; order.getOrderId().equals(orderId))</span>
<span class="nc" id="L280">                .findFirst();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (!target.isPresent()) return false;</span>
<span class="nc bnc" id="L282" title="All 3 branches missed.">        switch (OrderStatus.valueOf(target.get().getStatus())) {</span>
            case ISSUED:
<span class="nc" id="L284">                return shop.addOrder((OrderObj) target.get());</span>
            case PAYED:
<span class="nc" id="L286">                return true;</span>
            default:
<span class="nc" id="L288">                return false;</span>
        }
    }
    
    public boolean recordOrderArrival(Integer orderId) throws InvalidOrderIdException, InvalidLocationException, UnauthorizedException {
<span class="nc bnc" id="L293" title="All 4 branches missed.">        if (orderId == null || orderId &lt;= 0) throw new InvalidOrderIdException();</span>
<span class="nc" id="L294">        OrderObj order = shop.getTransactionManager().addCompletedOrder(orderId);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (order == null) return false;</span>
<span class="nc" id="L296">        String oldStatus = order.getStatus();</span>
<span class="nc" id="L297">        ProductTypeObj target = productMap.get(order.getProductCode());</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (target.getLocation().length() == 0) throw new InvalidLocationException();</span>
<span class="nc" id="L299">        int quantity = target.getQuantity();</span>
<span class="nc" id="L300">        target.setQuantity(quantity + order.getQuantity());</span>
        try {
<span class="nc" id="L302">            persistProducts();</span>
<span class="nc" id="L303">        } catch (IOException e) {</span>
<span class="nc" id="L304">            order.setStatus(oldStatus);</span>
<span class="nc" id="L305">            target.setQuantity(quantity);</span>
<span class="nc" id="L306">            shop.addOrder(order);</span>
<span class="nc" id="L307">        }</span>
<span class="nc" id="L308">        return true;</span>
    }
    
    
    private void persistProducts() throws IOException {
<span class="nc" id="L313">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L314">        mapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L315">                .writeValue(new File(PRODUCTS_PATH), productMap);</span>
        
<span class="nc" id="L317">    }</span>
    
    private void persistGen() throws IOException {
<span class="nc" id="L320">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L321">        mapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L322">                .writeValue(new File(PRODUCT_GEN_PATH), productIdGen);</span>
<span class="nc" id="L323">        mapper.writerWithDefaultPrettyPrinter()</span>
<span class="nc" id="L324">                .writeValue(new File(ORDER_GEN_PATH), orderIdGen);</span>
    
<span class="nc" id="L326">    }</span>
    
    public void clear() {
<span class="nc" id="L329">        productMap.clear();</span>
<span class="nc" id="L330">        File products = new File(PRODUCTS_PATH);</span>
<span class="nc" id="L331">        products.delete();</span>
<span class="nc" id="L332">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>